name: Build CV (page + PDF)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.md'
      - 'teaching.md'
      - 'research.md'
      - 'supervision.md'
      - 'service_contributions.md'
      - 'professional_activities.md'
      - 'professional_development.md'
      - '.github/scripts/build_cv_from_pages.py'
      - '.github/workflows/build-cv.yml'
      - 'assets/cv/**'
  workflow_dispatch: {}

concurrency:
  group: build-cv
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout site repo
        uses: actions/checkout@v4

      - name: Build cv.md from pages (expands <details>)
        run: |
          python3 .github/scripts/build_cv_from_pages.py
          cp out/cv.md cv.md

      # Use the static (patched) wkhtmltopdf build so headers/footers work on any Ubuntu runner
      - name: Install Pandoc + wkhtmltopdf (static patched)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y pandoc curl xfonts-75dpi xfonts-base
          curl -L -o wkhtmltox.tar.xz \
            https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox-0.12.6-1_linux-generic-amd64.tar.xz
          tar -xf wkhtmltox.tar.xz
          sudo mv wkhtmltox /opt/wkhtmltox
          sudo ln -sf /opt/wkhtmltox/bin/wkhtmltopdf /usr/local/bin/wkhtmltopdf
          sudo ln -sf /opt/wkhtmltox/bin/wkhtmltoimage /usr/local/bin/wkhtmltoimage
          wkhtmltopdf --version

      - name: Build PDF (wkhtmltopdf with header & footer)
        run: |
          set -euo pipefail
          mkdir -p assets/exports

          PDF_OPTS=()

          # Keep all margins in the same unit (mm)
          PDF_OPTS+=(--pdf-engine-opt=--margin-top --pdf-engine-opt=18mm)
          PDF_OPTS+=(--pdf-engine-opt=--margin-bottom --pdf-engine-opt=15mm)
          PDF_OPTS+=(--pdf-engine-opt=--margin-left --pdf-engine-opt=15mm)
          PDF_OPTS+=(--pdf-engine-opt=--margin-right --pdf-engine-opt=15mm)

          # Header: prefer repo file; otherwise simple text header + line
          if [ -f assets/cv/header.html ]; then
            PDF_OPTS+=(--pdf-engine-opt=--header-html --pdf-engine-opt=assets/cv/header.html)
          else
            PDF_OPTS+=(--pdf-engine-opt=--header-left --pdf-engine-opt="M. Avci â€¢ Curriculum Vitae")
            PDF_OPTS+=(--pdf-engine-opt=--header-line)
          fi

          # Footer: prefer repo file; otherwise page numbers
          if [ -f assets/cv/footer.html ]; then
            PDF_OPTS+=(--pdf-engine-opt=--footer-html --pdf-engine-opt=assets/cv/footer.html)
          else
            PDF_OPTS+=(--pdf-engine-opt=--footer-right --pdf-engine-opt="Page [page] of [toPage]")
          fi

          CSS_OPT=""
          if [ -f assets/cv/cv.css ]; then
            CSS_OPT="--css assets/cv/cv.css"
          fi

          pandoc out/cv.md \
            --from=gfm+yaml_metadata_block \
            -t html5 \
            --pdf-engine=wkhtmltopdf \
            $CSS_OPT \
            "${PDF_OPTS[@]}" \
            -o assets/exports/cv.pdf

      - name: Commit CV (md + PDF)
        run: |
          git config user.name  "github-actions"
          git config user.email "actions@github.com"
          git add cv.md assets/exports/cv.pdf
          git commit -m "Auto-build CV (md+pdf)" || echo "No changes to commit"
          git push
