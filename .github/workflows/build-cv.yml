name: Build CV (page + PDF)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.md'
      - 'teaching.md'
      - 'research.md'
      - 'supervision.md'
      - 'service_contributions.md'
      - 'professional_activities.md'
      - 'professional_development.md'
      - '.github/scripts/build_cv_from_pages.py'
      - '.github/workflows/build-cv.yml'
      - 'assets/cv/**'
  workflow_dispatch: {}

concurrency:
  group: build-cv
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout site repo
        uses: actions/checkout@v4

      - name: Build cv.md from pages (expands <details>)
        run: |
          python3 .github/scripts/build_cv_from_pages.py
          cp out/cv.md cv.md

      - name: Build PDF (Pandoc + Paged.js CSS header/footer)
        run: |
          mkdir -p assets/exports

          # Create CSS for running header + page numbers
          cat > assets/cv/cv.css <<'CSS'
          @page {
            margin: 20mm 15mm;
            @top-center {
              content: "M. Avci â€¢ Curriculum Vitae";
              font-size: 10pt;
              color: #555;
            }
            @bottom-center {
              content: "Page " counter(page) " of " counter(pages);
              font-size: 9pt;
              color: #777;
            }
          }
          body {
            font-family: "Helvetica", Arial, sans-serif;
            font-size: 11pt;
          }
          h1, h2, h3 {
            border-bottom: 1px solid #888;
            padding-bottom: 2px;
          }
          CSS

          # Generate PDF with Pandoc (Chrome via Paged.js under the hood)
          pandoc out/cv.md \
            --from=gfm+yaml_metadata_block \
            --css=assets/cv/cv.css \
            -t html5 \
            --pdf-engine=weasyprint \
            -o assets/exports/cv.pdf

      - name: Commit CV (md + PDF)
        run: |
          git config user.name  "github-actions"
          git config user.email "actions@github.com"
          git add cv.md assets/exports/cv.pdf
          git commit -m "Auto-build CV (md+pdf)" || echo "No changes to commit"
          git push
