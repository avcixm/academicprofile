name: Build CV (page + PDF)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.md'
      - 'teaching.md'
      - 'research.md'
      - 'supervision.md'
      - 'service_contributions.md'
      - 'professional_activities.md'
      - 'professional_development.md'        # NEW section you added
      - '.github/scripts/build_cv_from_pages.py'         # ensure script edits trigger
      - '.github/workflows/build-cv.yml'
      - 'assets/cv/**'                        # template/CSS/header assets
  workflow_dispatch: {}

permissions:
  contents: write     # we will commit cv.md + cv.pdf back to this repo

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout site repo
        uses: actions/checkout@v4

      - name: Build cv.md from pages (expands <details>)
        run: |
          python3 .github/scripts/build_cv_from_pages.py
          # also keep a top-level cv.md copy for convenience
          cp out/cv.md cv.md

      - name: Install Pandoc + wkhtmltopdf
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc wkhtmltopdf

      - name: Build PDF
        run: |
          mkdir -p assets/exports
          extra=""
          [ -f assets/cv/header.html ] && extra="$extra -H assets/cv/header.html"
          [ -f assets/cv/cv.css ] && extra="$extra --css assets/cv/cv.css"

          pandoc out/cv.md \
            --from=gfm+yaml_metadata_block \
            -t html5 \
            --pdf-engine=wkhtmltopdf \
            --pdf-engine-opt="--enable-local-file-access" \
            --pdf-engine-opt="--header-center Page [page] of [toPage] | M. Avci â€¢ Curriculum Vitae" \
            --pdf-engine-opt="--header-font-size 9" \
            --pdf-engine-opt="--header-spacing 6" \
            --pdf-engine-opt="--margin-top 20mm" \
            $extra \
            -o assets/exports/cv.pdf

      - name: Commit CV (md + PDF)
        run: |
          git config user.name  "github-actions"
          git config user.email "actions@github.com"
          git add cv.md assets/exports/cv.pdf
          git commit -m "Auto-build CV (md+pdf)" || echo "No changes to commit"
          git push
